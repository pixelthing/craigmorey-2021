<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diffing datalayer objects in GTM</title>

    <!-- META SEM/SHARING  --> 
    <meta property="og:locale" content="en_GB" />
    <meta property="og:url" content="https://www.pixelthing.se/posts/2021-05-diffing-datalaters/?utm_campaign=link-shared" />
    <meta property="og:site_name" content="pixelthing" />
    <meta property="og:title" content="Diffing datalayer objects in GTM" />
    <meta property="og:description" content="Spotting updates worth tracking" />
    <meta property="og:type" content="article" />
    
    <meta itemprop="name" content="Diffing datalayer objects in GTM" />
    <meta itemprop="description" content="Spotting updates worth tracking" />
    <meta name="twitter:card" content="summary" />
    <meta name="robots" content="index,follow" />
    <meta name="DC.Language" content="en" />

    <!-- META APP  -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#fdf6e3" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#001a25" media="(prefers-color-scheme: dark)" />
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.pixelthing.se/img/icon-512.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.pixelthing.se/img/icon-512.png" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="pixelthing" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="pixelthing" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" sizes="512-512" href="/img/icon-512.png" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#000000" />
    <meta name="msapplication-config" content="none" />
    <meta name="msapplication-navbutton-color" content="#ffffff" />
    <meta name="msapplication-starturl" content="/" />
    <meta name="msapplication-TileColor" content="#001a25" />
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-THTS63B');</script>
    <!-- End Google Tag Manager -->
    
    <link rel="stylesheet" href="/css/styles.css">

    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="pixelthing">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="pixelthing">
  </head>
  <body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-THTS63B"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
  
    <script src="/js/viewport.js" async></script>
    <script src="/js/cookies.js"></script>

    
    <header class="header">
    
      <h3 class="header__home"><a href="/" class="header__home__link"><span class="header__home__icon">&#10012;</span>pixelthing</a></h3>
      <h3 class="post-title-scrolled">
        <span class="post-title-scrolled__inner">here here here</span>
      </h3>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>
    

    <main class="post">
      
<figure class="post__hero">
  <div class="header__doppel" aria-hidden="true">
    <h3 class="header__home"><a href="/" class="header__home__link"><span class="header__home__icon">&#10012;</span>pixelthing</a></h3></h3>
  </div>
  
</figure> 

<div class="post__content">

<div class="post__meta">
  <a href="/" class="post__back">&#9666; <span>back</span></a>
  <time class="post__date" datetime="2021-05-17">17 May 2021</time>
  <span class="post__tags"><a href="/tags/analytics/" class="post-tag">analytics</a><a href="/tags/googletagmanager/" class="post-tag">googletagmanager</a></span>
</div>

<h1 class="post__title">Diffing datalayer objects in GTM</h1><h3 class="post__sub">Spotting updates worth tracking</h3><p>A large amount of the most critical work in Google Tag Manager (GTM) is in the monitoring of changes in state, particularly objects like eCommerce baskets, filter settings or user editable configurations. In these cases we generally want to know what caused a change to an object (and I'm using <em>&quot;object‚Äù</em> in compsci terms here), and what changes were made.</p>
<p>Let's take a real example. One list page that we deal with has a list of cars and a filter UI. In this app, the internal logic is not exposed to GTM, the only thing we see is a JS object that describes the current state of the filter - and when it's updated we see a new version appear:</p>
<pre class="language-js"><code class="language-js"></code></pre>
<p>How do we report what has changed if we're not told? In our case we use a helper function to diff between the previous and the newest filter object - we &quot;diff&quot; the two objects. We do this by firing a tag when we spot the filter was updated:</p>
<pre class="language-js"><code class="language-js">  objectRoot <span class="token operator">=</span> <span class="token string">'preconf.filter'</span><span class="token punctuation">;</span><br>  objectKeys <span class="token operator">=</span> <span class="token punctuation">[</span><br>    <span class="token string">'sort'</span><span class="token punctuation">,</span><br>    <span class="token string">'model'</span><span class="token punctuation">,</span><br>    <span class="token string">'delivery'</span><span class="token punctuation">,</span><br>    <span class="token string">'customer'</span><span class="token punctuation">,</span><br>    <span class="token string">'payment'</span><span class="token punctuation">,</span><br>    <span class="token string">'config.exterior'</span><span class="token punctuation">,</span><br>    <span class="token string">'config.interior'</span><span class="token punctuation">,</span><br>    <span class="token string">'config.packages'</span><span class="token punctuation">,</span><br>    <span class="token string">'config.rims'</span><br>  <span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">var</span> changes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token constant">ENV</span> <span class="token operator">-</span> helper <span class="token keyword">function</span> <span class="token operator">-</span> diff object <span class="token operator">-</span> <span class="token keyword">var</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span>objectRoot<span class="token punctuation">,</span> objectKeys<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">&amp;&amp;</span> changes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// DL push for each change</span><br>    changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">change</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      dataLayer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        event <span class="token operator">:</span> <span class="token string">'preconf.filter.choose.'</span> <span class="token operator">+</span> change<span class="token punctuation">.</span>key<span class="token punctuation">,</span><br>        <span class="token string">'preconf.change'</span><span class="token operator">:</span> change<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>        <span class="token string">'preconf.changeold'</span><span class="token operator">:</span> change<span class="token punctuation">.</span>valueOld<span class="token punctuation">,</span><br>        <span class="token string">'preconf.changenew'</span><span class="token operator">:</span> change<span class="token punctuation">.</span>valueNew<br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span></code></pre>
<p>Above, we pass into the helper function:</p>
<ul>
<li><code>objectRoot</code>: the part of the dataLayer that we're focusing on (in this case we looking at values in <code>dataLayer['preconf']</code>)</li>
<li><code>objectKeys</code>: a list of object keys that we're interested in if they change.</li>
</ul>
<p>The helper function outputs any changes as an array into the variable <code>changes</code>, which we can then loop through and create our own dataLayer pushes that inform any tags of the actual changes.</p>
<p>So what is in this diffing helpwe function? It's... er, big.</p>
<h2 id="the-code">The code <a class="direct-link" href="#the-code">#</a></h2>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">objectRoot<span class="token punctuation">,</span> objectKeys<span class="token punctuation">,</span> globalVar</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> gtm <span class="token operator">=</span> window<span class="token punctuation">.</span>google_tag_manager<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">{</span>Container <span class="token constant">ID</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> prevObject <span class="token operator">=</span> window<span class="token punctuation">[</span>globalVar<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> currentPush <span class="token operator">=</span> window<span class="token punctuation">.</span>dataLayer<span class="token punctuation">[</span>window<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token comment">//console.log('---')</span><br>    <span class="token comment">//console.log('prevObject',prevObject)</span><br>    <span class="token comment">//console.log('currentPush',currentPush)</span><br>    <span class="token keyword">var</span> changes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    objectKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <br>      <span class="token keyword">var</span> changeAction<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> changeKey<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> changeValue<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> oldValue<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> newValue<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> pipeDelim<span class="token punctuation">;</span><br><br>      <span class="token comment">// the values (before &amp; current) for the section of this event</span><br>      <span class="token keyword">var</span> prevValues<span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// NOTE!!! This uses a method Object.byString() </span><br>        <span class="token comment">// that needs you to load a helper method var</span><br>        <span class="token comment">// "ENV - helper function - resolve object from string - tag"</span><br>        <span class="token comment">// to be loaded before this is carried out. It's </span><br>        <span class="token comment">// suggested you do it at app/container load if you</span><br>        <span class="token comment">// intend to use this!</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Object<span class="token punctuation">.</span>byString <span class="token operator">||</span> <span class="token keyword">typeof</span> Object<span class="token punctuation">.</span>byString <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token comment">//console.log('method Object.byString() not available, make sure it\'s helper var "ENV - helper function - resolve object from string - tag" is loaded before this diff is run',object,Object.byString,typeof Object.byString);</span><br>          <span class="token keyword">return</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        prevValues <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">byString</span><span class="token punctuation">(</span>prevObject<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        prevValues <span class="token operator">=</span> prevObject<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">var</span> currentValues <span class="token operator">=</span> currentPush<span class="token punctuation">[</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> key<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token comment">//console.log('-prevValues',key,prevValues)</span><br>      <span class="token comment">//console.log('-currentValues',key,currentValues)</span><br>      <br>      <span class="token comment">// some values are in the form of pipe delimited strings (eg "A01068|A00492")</span><br>      <span class="token comment">// so treat those as arrays</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> prevValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> prevValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> currentValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> currentValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        prevValues <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> prevValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> prevValues<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        currentValues <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> currentValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> currentValues<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        pipeDelim <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">var</span> prevValuesIsArray <span class="token operator">=</span> <span class="token punctuation">(</span>prevValues <span class="token operator">?</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>prevValues<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> currentValuesIsArray <span class="token operator">=</span> <span class="token punctuation">(</span>currentValues <span class="token operator">?</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>currentValues<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <br>      <span class="token comment">//console.log('+prevValues',key,prevValues)</span><br>      <span class="token comment">//console.log('+prevValuesIsArray',key,prevValuesIsArray)</span><br>      <span class="token comment">//console.log('+currentValues',key,currentValues)</span><br>      <span class="token comment">//console.log('+currentValuesIsArray',key,currentValuesIsArray)</span><br>      <br>      <span class="token comment">// if this key doesn't exist in prev or latest, exit.</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues <span class="token operator">===</span> <span class="token keyword">undefined</span><br>        <span class="token operator">&amp;&amp;</span> currentValues <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// if we can evaluate no difference, skip.</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues <span class="token operator">!=</span> <span class="token keyword">undefined</span><br>        <span class="token operator">&amp;&amp;</span> currentValues <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// if array</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValuesIsArray <span class="token operator">&amp;&amp;</span> currentValuesIsArray<br>            <span class="token operator">&amp;&amp;</span> currentValues<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> prevValues<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span><span class="token punctuation">;</span><br>        <span class="token comment">// if string</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentValues <span class="token operator">===</span> prevValues<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// if no value before, it's a "choose" action</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> prevValues <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>        changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>        changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br><br>      <span class="token comment">// if value before, now gone, it's a "remove" action</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentValues <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> currentValues <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changeAction <span class="token operator">=</span> <span class="token string">'remove'</span><span class="token punctuation">;</span><br>        changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>        changeValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br>        <span class="token comment">// technical problem where pushing an array with less</span><br>        <span class="token comment">// keys does not remove a key, so we address GTM direct</span><br>        gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> changeKey<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <br>      <span class="token comment">// we're comparing two arrays</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValuesIsArray <span class="token operator">&amp;&amp;</span> currentValuesIsArray<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        oldValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        <span class="token comment">// if both 1 index each, it's a "choose"</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> currentValues<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>          changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>          changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        <span class="token comment">// if we're increasing the length of the array, it's a "choose"</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentValues<span class="token punctuation">.</span>length <span class="token operator">></span> prevValues<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>          changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>          changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token operator">!</span>prevValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// else if we're decreasing the length of an array, it's a "remove"</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          changeAction <span class="token operator">=</span> <span class="token string">'remove'</span><span class="token punctuation">;</span><br>          changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>          changeValue <span class="token operator">=</span> prevValues<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token operator">!</span>currentValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token comment">// technical problem where pushing an array with less</span><br>          <span class="token comment">// keys does not remove a key, so we address GTM direct</span><br>          gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> changeKey<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> changeKey<span class="token punctuation">,</span> currentValues<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>      <span class="token comment">// if we're comparing two strings</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>        changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>        changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// if any of the values are pipe delimited arrays, stick them back together</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>pipeDelim<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changeValue <span class="token operator">=</span> <span class="token punctuation">(</span>changeValue <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> changeValue<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> changeValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">?</span> oldValue<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token operator">?</span> newValue<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// add the change to the list</span><br>      <span class="token keyword">var</span> changesNode <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>changeAction<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changesNode <span class="token operator">=</span> <span class="token punctuation">{</span><br>          action <span class="token operator">:</span> changeAction<span class="token punctuation">,</span><br>          key<span class="token operator">:</span> changeKey<span class="token punctuation">,</span><br>          value <span class="token operator">:</span> changeValue<span class="token punctuation">,</span><br>          valueOld <span class="token operator">:</span> oldValue<span class="token punctuation">,</span><br>          valueNew <span class="token operator">:</span> newValue<br>        <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>changesNode<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">var</span> objectInDl <span class="token operator">=</span> gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>objectRoot<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">//console.log('**objectInDl',objectInDl)</span><br>    window<span class="token punctuation">[</span>globalVar<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>objectInDl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> changes<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>In addition to this, we extend the object prototype with a way of interrogating a JS object with a string notation, eg returning <code>OBJ['filter']['price']['low']</code> by asking for <code>filter.price.low</code>. This is particularly useful for us because we use namespaces in the dataLayer with dot notation that ends up creating deep JS objects. This method is added in our case by a GTM tag at the point the page loads:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token comment">// helper method to get a deep object value with a string key </span><br>  <span class="token comment">// (eg "filter.price.low" finds the object value OBJ['filter']['price']['low'])</span><br>  <span class="token comment">// o = the object to resolve, s = string of the key to find</span><br>  Object<span class="token punctuation">.</span><span class="token function-variable function">byString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">o<span class="token punctuation">,</span> s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[(\w+)\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'.$1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// convert indexes to properties</span><br>    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// strip a leading dot</span><br>    <span class="token keyword">var</span> a <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> a<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> k <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        o <span class="token operator">=</span> o<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> o<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>So what is all this stuff doing?</p>
<ol>
<li>retrieve the previous version of the object</li>
<li>retrieve the latest version of the object - direct from the dataLayer push array, not from the &quot;final&quot; dataLayer model held internally in GTM, because... well we'll get to that.</li>
<li>loop through the list of keys that we're interested in and figure out if they have had a value added, removed or modified.</li>
</ol>
<p>Of course the magic lies in that last step. We have to deal with comparing objects, arrays, strings, numbers and booleans. We have to address deep objects with string notation (that's the <code>.byString()</code> prototype that helps use look up a deep object with a string like <code>'preconf.filter.sortBy'</code>).</p>
<h3 id="removing-array-items-in-gtm">removing array items in GTM <a class="direct-link" href="#removing-array-items-in-gtm">#</a></h3>
<p>But the other problem this script deals with is a weird one. A regular dataLayer value - a &quot;type 2&quot; - will add items to an array, but not remove them. So you can have a dataLayer such as:</p>
<pre class="language-js"><code class="language-js">dataLayer<span class="token punctuation">.</span>myKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span></code></pre>
<p>...and then update it with one of the array values missing:</p>
<pre class="language-js"><code class="language-js">dataLayer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  myKey<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>...when you check the dataLayer, you'll see that the key has not been removed:</p>
<pre class="language-js"><code class="language-js">dataLayer<span class="token punctuation">.</span>myKey <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span></code></pre>
<p><a href="">Smarter people than me can explain why this happens</a>, but what I'm more interested in is how to get around it.</p>
<p>Firstly, we can't rely on the GTMs final representation of the dataLayer - so when we talk about the &quot;latest&quot; object, we need to pull it from the dataLayer push object in the JS global scope, hence the line about <code>window.dataLayer[window.dataLayer.length - 1]</code>.</p>
<p>Secondly, we need to have a way of setting the dataLayer with the new value in a reliable way. We do this by addressing the final dataLayer directly and using a GTM method <code>dataLayer.set()</code> to change the value.</p>


</div>

 <!--<hr>
<ul class="otherposts"><li>Next: <a href="/posts/2021-06-getting-analytics-into-dev-team/">Getting analytics into a dev sprint</a></li><li>Previous: <a href="/posts/2021-04-generic-gtm-click-tracking/">Generic click tracking in GTM</a></li>
</ul> -->

    </main>

    <footer class="footer">
      <div class="footer__inner">
        <div class="footer__author">
          <h3>Pixelthing</h3>
          <p> I'm <span rel="author">Craig Morey</span>, a data analyst & developer at <a href="https://www.polestar.com?utm_campaign=craigs.blog" target="_blank" rel="noopener">Polestar</a> in Gothenburg, Sweden (but originally from the UK). This is my place for collecting ramblings and curiosities, you're welcome/v√§lkomna!</p>        
          <p>Site made with <a href="https://11ty.dev" target="_blank" rel="noopener">Eleventy</a> on iPad. Source code available on [Github](https://github.com/pixelthing/craigmorey-2021). Images are my own or from <a href="https://unsplash.com" target="_blank" rel="noopener">Unsplash</a>.</p> 
        </div>
        <address class="footer__social social">
          <h3>Links</h3>
          <ul class="social__list">
            <li class="social__item social__item--rss">
              <a href="/feed/feed.xml" download="rss-feed.xml" class="social__link">
                <svg class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -256 1792 1792"><path d="M596.61 1154.17q0 80-56 136t-136 56q-80 0-136-56t-56-136q0-80 56-136t136-56q80 0 136 56t56 136zm512 123q2 28-17 48-18 21-47 21h-135q-25 0-43-16.5t-20-41.5q-22-229-184.5-391.5t-391.5-184.5q-25-2-41.5-20t-16.5-43v-135q0-29 21-47 17-17 43-17h5q160 13 306 80.5t259 181.5q114 113 181.5 259t80.5 306zm512 2q2 27-18 47-18 20-46 20h-143q-26 0-44.5-17.5t-19.5-42.5q-12-215-101-408.5t-231.5-336q-142.5-142.5-336-231.5t-408.5-102q-25-1-42.5-19.5t-17.5-43.5v-143q0-28 20-46 18-18 44-18h3q262 13 501.5 120t425.5 294q187 186 294 425.5t120 501.5z" fill="currentColor"/></svg>Site RSS feed</a>
            </li>
            <li class="social__item social__item--twitter">
              <a href="https://www.twitter.com/pixelthing" target="_blank" rel="noopener" class="social__link">
                <svg class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 171.505 139.378"><path d="M171.505 16.499a70.337 70.337 0 01-20.208 5.54c7.264-4.354 12.844-11.25 15.47-19.466a70.437 70.437 0 01-22.344 8.538A35.136 35.136 0 00118.74 0C99.308 0 83.553 15.754 83.553 35.185c0 2.758.311 5.444.912 8.019C55.22 41.737 29.295 27.728 11.94 6.44a35.019 35.019 0 00-4.764 17.69c0 12.207 6.211 22.977 15.653 29.286a35.047 35.047 0 01-15.937-4.4c-.004.146-.004.294-.004.442 0 17.048 12.129 31.268 28.225 34.503a35.224 35.224 0 01-15.89.602c4.478 13.979 17.472 24.152 32.87 24.435-12.042 9.438-27.214 15.063-43.7 15.063-2.84 0-5.64-.167-8.393-.492 15.572 9.984 34.067 15.81 53.938 15.81 64.72 0 100.113-53.616 100.113-100.114 0-1.526-.035-3.043-.102-4.553a71.483 71.483 0 0017.556-18.213z" fill="currentColor"/></svg>@pixelthing</a>
              <a href="https://www.twitter.com/itsadatathing" target="_blank" rel="noopener" class="social__link">@itsadatathing</a>
            </li>
            <li class="social__item social__item--instagram">
              <a href="https://www.instagram.com/pixelthing" target="_blank" rel="noopener" class="social__link">
                <svg class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="18 18 96 96"><path fill="currentColor" d="M66 18c-13 0-14.7 0-19.8.3a35 35 0 00-11.6 2.2 23.5 23.5 0 00-8.5 5.6 23.6 23.6 0 00-5.6 8.5c-1.2 3-2 6.5-2.2 11.6C18 51.3 18 53 18 66s0 14.7.3 19.8a35 35 0 002.2 11.6 23.5 23.5 0 005.6 8.5 23.5 23.5 0 008.5 5.6c3 1.2 6.5 2 11.6 2.2 5.1.2 6.8.3 19.8.3s14.7 0 19.8-.3a35 35 0 0011.6-2.2 23.5 23.5 0 008.5-5.6 23.6 23.6 0 005.6-8.5c1.2-3 2-6.5 2.2-11.6.2-5.1.3-6.8.3-19.8s0-14.7-.3-19.8c-.2-5.1-1-8.6-2.2-11.6a23.6 23.6 0 00-5.6-8.5 23.5 23.5 0 00-8.5-5.6c-3-1.2-6.5-2-11.6-2.2C80.7 18 79 18 66 18zm-4.3 8.7H66c12.8 0 14.3 0 19.4.2 4.7.2 7.2 1 9 1.7 2.1.8 3.7 1.9 5.4 3.6a14.9 14.9 0 013.6 5.5c.7 1.7 1.5 4.2 1.7 8.9.2 5 .3 6.6.3 19.4s-.1 14.3-.3 19.4c-.2 4.7-1 7.2-1.7 8.9a14.8 14.8 0 01-3.6 5.5 14.8 14.8 0 01-5.5 3.6 27 27 0 01-8.9 1.6c-5 .3-6.6.3-19.4.3-12.8 0-14.3 0-19.4-.2-4.7-.3-7.2-1-8.9-1.7a14.9 14.9 0 01-5.5-3.6 14.9 14.9 0 01-3.6-5.5c-.7-1.7-1.5-4.2-1.7-9-.2-5-.2-6.5-.2-19.3s0-14.4.2-19.4c.2-4.7 1-7.2 1.7-9a14.9 14.9 0 013.6-5.5 14.9 14.9 0 015.5-3.5c1.7-.7 4.2-1.5 8.9-1.7 4.4-.2 6.2-.3 15.1-.3zm30 8a5.8 5.8 0 105.7 5.7 5.8 5.8 0 00-5.8-5.8zM66 41.2a24.6 24.6 0 100 49.4 24.6 24.6 0 000-49.3zm0 8.7a16 16 0 110 32 16 16 0 010-32z"/></svg>@pixelthing</a>
              <a href="https://www.instagram.com/itsadatathing" target="_blank" rel="noopener" class="social__link">@itsadatathing</a>
            </li>
            <li class="social__item social__item--linkedin">
              <a href="https://www.linkedin.com/in/craigmorey/" target="_blank" rel="noopener" class="social__link">
                <svg  class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 455 455"><g fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"><path d="M246.4 204.35v-.665c-.136.223-.324.446-.442.665h.442z"/><path d="M0 0v455h455V0H0zm141.522 378.002H74.016V174.906h67.506v203.096zm-33.753-230.816h-.446C84.678 147.186 70 131.585 70 112.085c0-19.928 15.107-35.087 38.211-35.087 23.109 0 37.31 15.159 37.752 35.087 0 19.5-14.643 35.101-38.194 35.101zM385 378.002h-67.524V269.345c0-27.291-9.756-45.92-34.195-45.92-18.664 0-29.755 12.543-34.641 24.693-1.776 4.34-2.24 10.373-2.24 16.459v113.426h-67.537s.905-184.043 0-203.096H246.4v28.779c8.973-13.807 24.986-33.547 60.856-33.547 44.437 0 77.744 29.02 77.744 91.398v116.465z"/></g></svg>Linked In</a>
            </li>
          </ul>
        </address>
        <div class="footer__cookies">
          <div id="cookie-dialog-1">
            <h3>Cookies & Tracking</h3>
            <p>This site uses a few cookies & yes, Google Analytics.<p>
            <p>Because it's nice to know if anyone is reading this stuff.</p>
            <p>If you accept cookies, your data is never sold & you are never targeted or tracked cross-site.</p>
          </div>
          
          <div id="cookie-dialog-2" class="cookies__buttons">
            <button type="submit" id="dialog-cookie-accept" class="cookies__button cookies__button--accept"> Accept </button>
            <button type="submit" id="dialog-cookie-reject" class="cookies__button cookies__button--reject">No to cookies</button>
          </div>
        </div>
        <div class="footer__settings">
          <h3>Settings</h3>
          
          <fieldset class="cookies__settings">
            <legend class="cookies__settings__legend">Your cookie settings</legend>
            <div class="cookies__item">
              <p class="cookies__item__text">Accept functional cookies needed to run the site (required)</p>
              <div class="toggle">
                <input type="radio" class="toggle__input toggle__input--no" disabled />
                <input type="radio" class="toggle__input toggle__input--yes" checked disabled />
                <span class="toggle__slug"></span>
              </div>
            </div>
            <div class="cookies__item">
              <p class="cookies__item__text">Accept Google Analytics cookies </p>
              <div class="toggle">
                <input id="settings-cookie-reject" type="radio" class="toggle__input toggle__input--no" name="cookies-analytics" />
                <label for="settings-cookie-reject" class="toggle__text">Opt-out</label>
                <input id="settings-cookie-accept" type="radio" class="toggle__input toggle__input--yes" name="cookies-analytics" />
                <label for="settings-cookie-accept" class="toggle__text">Accept</label>
                <input type="radio" class="toggle__input toggle__input--maybe" name="cookies-analytics" disabled checked />
                <label class="toggle__text">Undecided</label>
                <span class="toggle__slug"></span>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
    </footer>
    
    
    <script src="/js/image-enlarge.js" async></script>
    <script src="/js/post-title-scroll.js" async></script>
    
    
  </body>
</html>