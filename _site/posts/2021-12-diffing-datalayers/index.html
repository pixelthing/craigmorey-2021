<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diffing objects in GTM</title>

    <!-- META SEM/SHARING  --> 
    <meta property="og:locale" content="en_GB" />
    <meta property="og:url" content="https://www.pixelthing.se/posts/2021-12-diffing-datalayers/?utm_campaign=link-shared" />
    <meta property="og:site_name" content="pixelthing" />
    <meta property="og:title" content="Diffing objects in GTM" />
    <meta property="og:description" content="Spotting state updates worth tracking" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="https://www.pixelthing.se/img/2021-12-diffing-datalayers-hero-tb.jpeg" />
    <meta property="og:image:width" content="665" />
    <meta property="og:image:height" content="500" />
    <meta itemprop="name" content="Diffing objects in GTM" />
    <meta itemprop="description" content="Spotting state updates worth tracking" />
    <meta name="twitter:card" content="summary" />
    <meta name="robots" content="index,follow" />
    <meta name="DC.Language" content="en" />

    <!-- META APP  -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#fdf6e3" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#001a25" media="(prefers-color-scheme: dark)" />
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.pixelthing.se/img/icon-512.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.pixelthing.se/img/icon-512.png" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="pixelthing" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="pixelthing" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="apple-touch-icon" sizes="512-512" href="/img/icon-512.png" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#000000" />
    <meta name="msapplication-config" content="none" />
    <meta name="msapplication-navbutton-color" content="#ffffff" />
    <meta name="msapplication-starturl" content="/" />
    <meta name="msapplication-TileColor" content="#001a25" />
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-THTS63B');</script>
    <!-- End Google Tag Manager -->
    
    <link rel="stylesheet" href="/css/styles.css">

    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="pixelthing">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="pixelthing">
  </head>
  <body>

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-THTS63B"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
  
    <script src="/js/viewport.js" async></script>
    <script src="/js/cookies.js"></script>

    
    <header class="header">
    
      <h3 class="header__home"><a href="/" class="header__home__link"><span class="header__home__icon">&#10012;</span>pixelthing</a></h3>
      <h3 class="post-title-scrolled">
        <span class="post-title-scrolled__inner">here here here</span>
      </h3>
      <ul class="nav">
        <li class="nav-item"><a href="/">Home</a></li>
        <li class="nav-item"><a href="/posts/">Archive</a></li>
        <li class="nav-item"><a href="/about/">About Me</a></li>
      </ul>
    </header>
    

    <main class="post">
      
<figure class="post__hero">
  <div class="header__doppel" aria-hidden="true">
    <h3 class="header__home"><a href="/" class="header__home__link"><span class="header__home__icon">&#10012;</span>pixelthing</a></h3></h3>
  </div>
  
  <picture class="post__hero__picture">   
    <source media="(max-width:599px)" srcset="../../img/2021-12-diffing-datalayers-hero-sm.jpeg" />
    <source media="(max-width:1799px)" srcset="../../img/2021-12-diffing-datalayers-hero-lg.jpeg" />
    <source media="(min-width:1800px)" srcset="../../img/2021-12-diffing-datalayers-hero-xl.jpeg" />
    <img src="../../img/2021-12-diffing-datalayers-hero-xl.jpeg" loading="eager" width="2360" height="1240" alt="title picture for article" class="post__hero__img" />
  </picture>
  
</figure> 

<div class="post__content">

<div class="post__meta">
  <a href="/" class="post__back">&#9666; <span>back</span></a>
  <time class="post__date" datetime="2021-12-28">28 Dec 2021</time>
  <span class="post__tags"><a href="/tags/analytics/" class="post-tag">analytics</a><a href="/tags/googletagmanager/" class="post-tag">googletagmanager</a></span>
</div>

<h1 class="post__title">Diffing objects in GTM</h1><h3 class="post__sub">Spotting state updates worth tracking</h3><p>A large amount of the most critical work in Google Tag Manager (GTM) is in the monitoring of changes in state, particularly objects like eCommerce baskets, filter settings or user editable configurations. In these cases we generally want to know what caused a change to an object (and I'm using <em>&quot;object‚Äù</em> in compsci terms here - ie, <em>a JS object</em>), and what changes are made to it.</p>
<p>Let's take a real example. One list page that we deal with at <a href="https://www.polestar.com">Polestar</a> has a list of cars and a filter UI. In this app, the internal logic is not exposed to GTM, the only thing we see is a JS object that describes the current state of the filter - and when it's updated we see a new version appear:</p>
<pre class="language-js"><code class="language-js">dataLayer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  event<span class="token operator">:</span> <span class="token string">"Preconf.List"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>totalCars<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>currency<span class="token operator">:</span> <span class="token string">"SEK"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>sort<span class="token operator">:</span> <span class="token string">"DeliveryDateAsc"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>model<span class="token operator">:</span> <span class="token string">"534"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>delivery<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>customer<span class="token operator">:</span> <span class="token string">"b2c"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>payment<span class="token operator">:</span> <span class="token string">"Cash"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>price<span class="token punctuation">.</span>low<span class="token operator">:</span> <span class="token string">"555200"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>price<span class="token punctuation">.</span>high<span class="token operator">:</span> <span class="token string">"555200"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>config<span class="token punctuation">.</span>exterior<span class="token operator">:</span> <span class="token string">"All"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>config<span class="token punctuation">.</span>interior<span class="token operator">:</span> <span class="token string">"All"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>config<span class="token punctuation">.</span>packages<span class="token operator">:</span> <span class="token string">"All"</span><span class="token punctuation">,</span><br>  preconf<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rims<span class="token operator">:</span> <span class="token string">"All"</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>Ok - so the dataLayer is telling us that the car list was updated - probably because the filter was changed. So what did change? The answer is we have no idea - we only know what the new state of the filter is.</p>
<p>In a perfect world the web app would tell us in the dataLayer what changed, not just the current state in full. But it's not a perfect world and providing that extra info is often quite a chunk of extra work for webdevs.</p>
<p>How do we report what has changed if we're not told? In our case we <em>&quot;diff&quot;</em> between the previous and the newest filter state - spotting any changes that have occured - and then create our own dataLayer events in a GTM HTML tag.</p>
<h3 id="setup-tag">Setup tag <a class="direct-link" href="#setup-tag">#</a></h3>
<p>First we need to capture the default filter state at the point that the web app has loaded and is ready. This is important as we need to know the default settings to be able to spot any changes from them.</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- GTM custom HTML tag, fired by a trigger when the app loads, ie the `Preconf.Load` dataLayer event (you might choose DOM ready or window loaded for this page instead) --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    window<span class="token punctuation">.</span>gtmFilterPrev <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token constant">CONF</span> <span class="token operator">-</span> config <span class="token operator">-</span> <span class="token keyword">var</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>Note that in the above we're pulling the part of the dataLayer that we're interested in monitoring (<code>{{CONF - config - var}}</code> - a GTM Datalayer variable that is just <code>preconf.filter</code>), and stick it in a global scoped JS var  <code>gtmFilterPrev</code>. We'll use that var in a moment.</p>
<h3 id="the-state-change-tag">The state change tag <a class="direct-link" href="#the-state-change-tag">#</a></h3>
<p>Now we need another tag to fire each time a state update occurs (again, this is just an example, you can customize it to do what you want):</p>
<pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- GTM custom HTML tag, fired by a trigger that spots the above `Preconf.List` dataLayer event  --></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>    <span class="token comment">// a name of a variable that we'll use in the global scope (ie window.gtmFilterPrev) to hold the "old" state object, so that we can diff the "new" state object against it</span><br>    <span class="token keyword">var</span> globalVar <span class="token operator">=</span> <span class="token string">'gtmFilterPrev'</span><span class="token punctuation">;</span><br>    <span class="token comment">// the root in the dataLayer to the keys we're interested in - eg, the monitoring the key "sort" would actually be monitoring the dataLayer value "preconf.filter.sort"</span><br>    <span class="token keyword">var</span> objectRoot <span class="token operator">=</span> <span class="token string">'preconf.filter'</span><span class="token punctuation">;</span> <br>    <span class="token comment">// setup what we want to monitor in the state object (all other keys that change will be ignored)</span><br>    <span class="token keyword">var</span> objectKeys <span class="token operator">=</span> <span class="token punctuation">[</span><br>      <span class="token string">'sort'</span><span class="token punctuation">,</span><br>      <span class="token string">'model'</span><span class="token punctuation">,</span><br>      <span class="token string">'delivery'</span><span class="token punctuation">,</span><br>      <span class="token string">'customer'</span><span class="token punctuation">,</span><br>      <span class="token string">'payment'</span><span class="token punctuation">,</span><br>      <span class="token string">'config.exterior'</span><span class="token punctuation">,</span><br>      <span class="token string">'config.interior'</span><span class="token punctuation">,</span><br>      <span class="token string">'config.packages'</span><span class="token punctuation">,</span><br>      <span class="token string">'config.rims'</span><br>    <span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token comment">// diff the filter state object in a shared helper function (a GTM JS variable)</span><br>    <span class="token keyword">var</span> changes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token constant">ENV</span> <span class="token operator">-</span> helper method <span class="token operator">-</span> diff object <span class="token operator">-</span> <span class="token keyword">var</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">(</span>objectRoot<span class="token punctuation">,</span> objectKeys<span class="token punctuation">,</span> globalVar<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// if any useful filter state changes have been found</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">&amp;&amp;</span> changes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token comment">// tell the dataLayer that the filter was changed meaningfully</span><br>      dataLayer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        event <span class="token operator">:</span> <span class="token string">'preconf.move.filter'</span><span class="token punctuation">,</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token comment">// create a dataLayer push to detail each change</span><br>      changes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">change</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        dataLayer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>          event <span class="token operator">:</span> <span class="token string">'preconf.filter.'</span> <span class="token operator">+</span> change<span class="token punctuation">.</span>action <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> change<span class="token punctuation">.</span>key<span class="token punctuation">,</span><br>          <span class="token string">'preconf.change'</span><span class="token operator">:</span> change<span class="token punctuation">.</span>value<span class="token punctuation">,</span><br>          <span class="token string">'preconf.changeold'</span><span class="token operator">:</span> change<span class="token punctuation">.</span>valueOld<span class="token punctuation">,</span><br>          <span class="token string">'preconf.changenew'</span><span class="token operator">:</span> change<span class="token punctuation">.</span>valueNew<br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>The lifecycle then becomes:</p>
<ul>
<li>When a state update is fired (like the one detailed at the start of this article), this tag will be triggered.</li>
<li>Using a shared helper method, it will trawl through a list of predefined object keys to spot what has changed in the dataLayer. This is reported back as an array of all the monitored keys that have been updated in the array variable <code>changes</code>.</li>
<li>If the <code>changes</code> var has any values in the array, we'll tell the dataLayer that a filter change has definitely occured and additionally loop through it to fire dataLayer pushes - one for every change - each listing what changed, plus the old &amp; new value.</li>
</ul>
<p>So what is in this magical diffing helper method? It's... er, big.</p>
<h2 id="the-helper-method-code">The helper method code <a class="direct-link" href="#the-helper-method-code">#</a></h2>
<p>This is a GTM custom JS var that returns a function - it's referred to in tha above tag by it's name in our GTM container <code>{{ENV - helper method - diff object - var}}</code>. It can be reused by any GTM custom JS tag (or other GTM custom JS vars). Here it is in full:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">/* GTM custom JS var */</span><br><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// helper method to get a deep object value with a string key </span><br>  <span class="token comment">// (eg "filter.price.low" finds the object value OBJ['filter']['price']['low'])</span><br>  <span class="token comment">// o = the object to resolve, s = string of the key to find</span><br>  Object<span class="token punctuation">.</span><span class="token function-variable function">byString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">o<span class="token punctuation">,</span> s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[(\w+)\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'.$1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// convert indexes to properties</span><br>    s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// strip a leading dot</span><br>    <span class="token keyword">var</span> a <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> a<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> k <span class="token operator">=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        o <span class="token operator">=</span> o<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> o<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token comment">// this is the actual diffing helper method</span><br>  <span class="token comment">// - objectRoot: string. the root of all the keys on the dataLayer, eg if we looking for "colour" and "rims" keys sitting in "site.car.config", then that is the objectRoot</span><br>  <span class="token comment">// - objectKeys: array. keys to monitor for changes between states. eg ['colour','rims','interior.trim']</span><br>  <span class="token comment">// - globalVar: string. the name of a global scoped variable that we temporarily hold the previous state in, eg "gtmfilterPrevState"</span><br>  <span class="token comment">// - ignoreBlanks: boolean. If true, each key will ignore changes to-or-from a blank state (eg '' or undefined), only between actual values (eg, "red" to "blue"). If false, any change will be reported.</span><br>  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">objectRoot<span class="token punctuation">,</span> objectKeys<span class="token punctuation">,</span> globalVar<span class="token punctuation">,</span> ignoreBlanks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// get the gtm JS object and all it's method</span><br>    <span class="token keyword">var</span> gtm <span class="token operator">=</span> window<span class="token punctuation">.</span>google_tag_manager<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">{</span>Container <span class="token constant">ID</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token comment">// get the previous state from the global JS scope</span><br>    <span class="token keyword">var</span> prevObject <span class="token operator">=</span> window<span class="token punctuation">[</span>globalVar<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token comment">// step back through the DL pushes until we find the dataLayer push that triggered this tag</span><br>    <span class="token keyword">var</span> dataLayerStack <span class="token operator">=</span> window<span class="token punctuation">.</span>dataLayer<span class="token punctuation">;</span><br>    <span class="token keyword">var</span> dataLayerView<span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> dataLayerStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> dataLayerSent <span class="token operator">=</span> dataLayerStack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>dataLayerSent<span class="token punctuation">.</span>event <span class="token operator">===</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>Event<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        currentPush <span class="token operator">=</span> dataLayerSent<span class="token punctuation">;</span><br>        i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// stop the loop here</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br>    <span class="token comment">// warm up the 'changes' var by starting it as an empty array</span><br>    <span class="token keyword">var</span> changes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token comment">// loop every key that we're interested in monitoring...</span><br>    objectKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">var</span> changeAction<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> changeKey<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> changeValue<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> oldValue<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> newValue<span class="token punctuation">;</span><br>      <span class="token keyword">var</span> pipeDelim<span class="token punctuation">;</span><br>      <span class="token comment">// the values (before &amp; current) for the section of this event</span><br>      <span class="token keyword">var</span> prevValues<span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        prevValues <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">byString</span><span class="token punctuation">(</span>prevObject<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        prevValues <span class="token operator">=</span> prevObject<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">var</span> currentValues <span class="token operator">=</span> currentPush<span class="token punctuation">[</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> key<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token comment">// some values are in the form of pipe delimited strings (eg "A01068|A00492"),</span><br>      <span class="token comment">// so treat those as arrays</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> prevValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> prevValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> currentValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> currentValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        prevValues <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> prevValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> prevValues<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        currentValues <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> currentValues <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> currentValues<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        pipeDelim <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// is this value (in the pre or current state) an array?</span><br>      <span class="token keyword">var</span> prevValuesIsArray <span class="token operator">=</span> <span class="token punctuation">(</span>prevValues <span class="token operator">?</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>prevValues<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">var</span> currentValuesIsArray <span class="token operator">=</span> <span class="token punctuation">(</span>currentValues <span class="token operator">?</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>currentValues<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token comment">// if this key doesn't exist in prev or latest, exit.</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues <span class="token operator">===</span> <span class="token keyword">undefined</span><br>        <span class="token operator">&amp;&amp;</span> currentValues <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// if we can evaluate no difference, exit.</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues <span class="token operator">!=</span> <span class="token keyword">undefined</span><br>        <span class="token operator">&amp;&amp;</span> currentValues <span class="token operator">!=</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token comment">// if array</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValuesIsArray <span class="token operator">&amp;&amp;</span> currentValuesIsArray<br>            <span class="token operator">&amp;&amp;</span> currentValues<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> prevValues<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span><span class="token punctuation">;</span><br>        <span class="token comment">// if string</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentValues <span class="token operator">===</span> prevValues<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// if we ignore any values that are turning to/coming from</span><br>      <span class="token comment">// undefined or "" (ie, only registering changes between values),</span><br>      <span class="token comment">// exit here if a blank is found</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreBlanks <span class="token operator">&amp;&amp;</span> <br>         <span class="token punctuation">(</span>prevValues <span class="token operator">===</span> <span class="token keyword">undefined</span> <br>          <span class="token operator">||</span> prevValues <span class="token operator">===</span> <span class="token string">''</span> <br>          <span class="token operator">||</span> currentValues <span class="token operator">===</span> <span class="token keyword">undefined</span> <br>          <span class="token operator">||</span> currentValues <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// if no value before, it's a "choose" action</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> prevValues <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>        changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>        changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br><br>      <span class="token comment">// if value before, now gone, it's a "remove" action</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentValues <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> currentValues <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changeAction <span class="token operator">=</span> <span class="token string">'remove'</span><span class="token punctuation">;</span><br>        changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>        changeValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><br>        <span class="token comment">// technical problem where pushing an array with less</span><br>        <span class="token comment">// keys does not remove a key, so we address GTM direct</span><br>        gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> changeKey<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <br>      <span class="token comment">// we're comparing two arrays</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValuesIsArray <span class="token operator">&amp;&amp;</span> currentValuesIsArray<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        oldValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        <span class="token comment">// if both 1 index each, it's a "choose"</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevValues<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> currentValues<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>          changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>          changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        <span class="token comment">// if we're increasing the length of the array, it's a "choose"</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentValues<span class="token punctuation">.</span>length <span class="token operator">></span> prevValues<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>          changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>          changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token operator">!</span>prevValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token comment">// else if we're decreasing the length of an array, it's a "remove"</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          changeAction <span class="token operator">=</span> <span class="token string">'remove'</span><span class="token punctuation">;</span><br>          changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>          changeValue <span class="token operator">=</span> prevValues<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token operator">!</span>currentValues<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          <span class="token comment">// technical problem where pushing an array with less</span><br>          <span class="token comment">// keys does not remove a key, so we address GTM direct</span><br>          gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> changeKey<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>objectRoot <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> changeKey<span class="token punctuation">,</span> currentValues<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>      <span class="token comment">// if we're comparing two strings</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        changeAction <span class="token operator">=</span> <span class="token string">'choose'</span><span class="token punctuation">;</span><br>        changeKey <span class="token operator">=</span> key<span class="token punctuation">;</span><br>        changeValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> prevValues<span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> currentValues<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// if this key's values are pipe delimited srings that we treated as arrays, stick them back together</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>pipeDelim<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changeValue <span class="token operator">=</span> <span class="token punctuation">(</span>changeValue <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> changeValue<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> changeValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">)</span> <span class="token operator">?</span> oldValue<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        newValue <span class="token operator">=</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token operator">?</span> newValue<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">:</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>      <span class="token comment">// add the change to the changes array</span><br>      <span class="token keyword">var</span> changesNode <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>changeAction<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        changesNode <span class="token operator">=</span> <span class="token punctuation">{</span><br>          action <span class="token operator">:</span> changeAction<span class="token punctuation">,</span><br>          key<span class="token operator">:</span> changeKey<span class="token punctuation">,</span><br>          value <span class="token operator">:</span> changeValue<span class="token punctuation">,</span><br>          valueOld <span class="token operator">:</span> oldValue<span class="token punctuation">,</span><br>          valueNew <span class="token operator">:</span> newValue<br>        <span class="token punctuation">}</span><span class="token punctuation">;</span><br>        changes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>changesNode<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// set the "previous state" in the global scope to the new "current state".</span><br>    <span class="token keyword">var</span> objectInDl <span class="token operator">=</span> gtm<span class="token punctuation">.</span>dataLayer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>objectRoot<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    window<span class="token punctuation">[</span>globalVar<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>objectInDl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// rurn the changes</span><br>    <span class="token keyword">return</span> changes<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>So what is all the above stuff doing?</p>
<ol>
<li>retrieve the previous version of the state object that we stored in a global JS variable (in the above case <code>window.gtmFilterPrev</code>).</li>
<li>then retrieve the latest version of the state object - and this is important - <em>directly from the dataLayer push array</em>, <strong>not</strong> from the &quot;final&quot; dataLayer model held internally in GTM, because... well we'll get to that...</li>
<li>loop through the list of keys that we're interested in and figure out if they have had a value added, removed or modified.</li>
</ol>
<p>The magic lies in that last step. We have to deal with comparing objects, arrays, strings, numbers and booleans. We have to address deep objects with string notation (that's the <code>.byString()</code> prototype that helps use look up a deep object with a string like <code>'preconf.filter.sortBy'</code>).</p>
<h3 id="side-issue%3A-dealing-with-array-values-in-the-datalayer">Side-issue: dealing with array values in the dataLayer <a class="direct-link" href="#side-issue%3A-dealing-with-array-values-in-the-datalayer">#</a></h3>
<p>The diff helper method also has to deal with one particularly weird problem. A regular dataLayer value - a <em>&quot;version 2&quot;</em> dataLayer - will add or edit items to an array, but not remove them. For example, a list of filter checkboxes could be represented in a dataLayer as such:</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span><br>  filtersChecked<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<p>...and then a dataLayer event could tell the dataLayer that one of the checkboxes has been unchecked:</p>
<pre class="language-js"><code class="language-js">dataLayer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  event<span class="token operator">:</span> <span class="token string">'Preconf.List.Updated'</span><span class="token punctuation">,</span><br>  filtersChecked<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>  carsShown<span class="token operator">:</span> <span class="token number">7</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>...but when you check the dataLayer, you'll see that the third checkbox has not been removed:</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span><br>  filtersChecked<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<p><a href="https://www.simoahava.com/gtm-tips/data-layer-variable-versions-explained/">Smarter people than me can explain why this happens</a>, but I'm more interested in how to get around it.</p>
<p>The version 2 dataLayer problem gives us two problems to solve:</p>
<ul>
<li>Firstly, we can't rely on the GTMs final representation of the dataLayer - a dataLayer push event might <em>say</em> that a value is being removed from an array, but the final dataLayer won't reflect that. So when we talk about the &quot;latest&quot; state object, we need to pull it from <em>the original dataLayer push array itself</em> (ie, the array you see if you just type in <code>dataLayer</code> into the browser console). Hence the routine in the helper method that steps back through the dataLayer pushes to find the event that triggered the tag in the first place (because you can't assume it was the &quot;last&quot; dataLayer push - there's an amount of ansynchronicity in GTM that means it's not always true).</li>
<li>Secondly, we need to have a way of setting the <em>real</em> array value on the dataLayer in a reliable way. We do this by addressing the final dataLayer directly and using a GTM method <code>dataLayer.set()</code>, to change the value in JS. We use it first to <em>unset</em> an array value (by setting it as <code>undefined</code>), then reset to the correct value - this way we're guaranteed the final dataLayer reflects the original push, even if we're removing values from an array.</li>
</ul>
<p>The diffing helper method script solves both of the above problems.</p>
<h3 id="ok%2C-all-this-is-in-place%2C-what-now%3F">Ok, all this is in-place, what now? <a class="direct-link" href="#ok%2C-all-this-is-in-place%2C-what-now%3F">#</a></h3>
<p>You now have new dataLayer events that tell you when things change and specifically what has changed:</p>
<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span><br>  event<span class="token operator">:</span> <span class="token string">'preconf.move.filter'</span><br><span class="token punctuation">}</span><br><span class="token punctuation">{</span><br>  event <span class="token operator">:</span> <span class="token string">'preconf.filter.choose.model'</span><span class="token punctuation">,</span><br>  <span class="token string">'preconf.change'</span><span class="token operator">:</span> <span class="token string">'Leasing'</span><span class="token punctuation">,</span><br>  <span class="token string">'preconf.changeold'</span><span class="token operator">:</span> <span class="token string">'Cash'</span><span class="token punctuation">,</span><br>  <span class="token string">'preconf.changenew'</span><span class="token operator">:</span> <span class="token string">'Leasing'</span> <span class="token comment">// almost always the same as preconf.change, but not always...</span><br><span class="token punctuation">}</span><br><span class="token punctuation">{</span><br>  event <span class="token operator">:</span> <span class="token string">'preconf.filter.remove.rims'</span><span class="token punctuation">,</span><br>  <span class="token string">'preconf.change'</span><span class="token operator">:</span> <span class="token string">'RX11111'</span><span class="token punctuation">,</span> <span class="token comment">// with "remove" actions, the change is reported as the option removed, not the new value - which is empty - err, because it was removed.</span><br>  <span class="token string">'preconf.changeold'</span><span class="token operator">:</span> <span class="token string">'RX11111'</span><span class="token punctuation">,</span><br>  <span class="token string">'preconf.changenew'</span><span class="token operator">:</span> <span class="token string">''</span> <br><span class="token punctuation">}</span></code></pre>
<p>Note that in this example, the tag we wrote sends a single event <code>preconf.move.filter</code> to tell other tags that a filter change occured (and remember we determine which <code>objectKeys</code> count as a change, the rest are ignored), and then a dataLayer event detailing each change that was part of that event. In this case a single user event had several effects - swapping to leasing also meant that the user lost their choice of wheels (just an example, this doesn't happen in the real website) - something that is hard to code into the webapp dataLayer push.</p>
<p>You can use these events to trigger analytics, optimisation or marketing tags only when something important changes. That's a lot more useful than triggering a tag every time a state change occurs and <em>still</em> not be able to tell analytics <em>what</em> changed.</p>
<p>Importantly, this also helps us <em>not</em> record any events that show no changes at all. If you've ever worked with anaytics in complex single-page-applications such as React or Vue, you'll know that they are sometimes built to refresh state on completely unrelated events - so the app will fire multiple dataLayer events even though the state actually hasn't changed. With this diffing method, your tags can now be triggered only on a meaningful change, instead recording dataLayer events unrelated to user actions.</p>
<p>Being a helper method means that we can reuse the same pattern in lots of different situations - list page filters, driving range calculators, car configuration states - all referring to the same JS code in a GTM var, to diff any updates to state objects across the site.</p>
<h3 id="epilogue">Epilogue <a class="direct-link" href="#epilogue">#</a></h3>
<p>At <a href="https://www.polestar.com">Polestar</a>, we consider this as much a part of good developer relations as it is a technical solution. We need dev teams to assist us analysts in getting useful and reliable dataLayer pushes into their web apps. But they have backlogs and pressure that often leave any extra work for analytics way down the priority list.</p>
<p>However, devs often have a JS state object already in the app (eg Flux, JSON, etc), so we have the option of asking them to just place it into a dataLayer push - and we can take it from there. There's no extra complexity that they need to add to their code, because we carry out the diffs in GTM. We can then use any dev time that we saved to ask them for other more specific requests.</p>
<p>As an added bonus, when the web app code inevitably changes and a new option appears in the state object, we don't need to re-schedule more web app dev-time to update the dataLayer push - if it's just their state object they're pushing, the extra key just appears in the dataLayer, and we just need to tweak our tag to recognise it.</p>


</div>

 <!--<hr>
<ul class="otherposts"><li>Previous: <a href="/posts/2021-09-gtm-tracking-internal/">Flagging internal remote users in GTM</a></li>
</ul> -->

    </main>

    <footer class="footer">
      <div class="footer__inner">
        <div class="footer__author">
          <h3>Pixelthing</h3>
          <p> I'm <span rel="author">Craig Morey</span>, a data analyst & developer at <a href="https://www.polestar.com?utm_campaign=craigs.blog" target="_blank" rel="noopener">Polestar</a> in Gothenburg, Sweden (but originally from the UK). This is my place for collecting ramblings and curiosities, you're welcome/v√§lkomna!</p>        
          <p>Site made with <a href="https://11ty.dev" target="_blank" rel="noopener">Eleventy</a> on iPad. Source code available on <a href="https://github.com/pixelthing/craigmorey-2021">GitHub</a>. Images are my own or from <a href="https://unsplash.com" target="_blank" rel="noopener">Unsplash</a>.</p> 
        </div>
        <address class="footer__social social">
          <h3>Links</h3>
          <ul class="social__list">
            <li class="social__item social__item--rss">
              <a href="/feed/feed.xml" download="rss-feed.xml" class="social__link">
                <svg class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -256 1792 1792"><path d="M596.61 1154.17q0 80-56 136t-136 56q-80 0-136-56t-56-136q0-80 56-136t136-56q80 0 136 56t56 136zm512 123q2 28-17 48-18 21-47 21h-135q-25 0-43-16.5t-20-41.5q-22-229-184.5-391.5t-391.5-184.5q-25-2-41.5-20t-16.5-43v-135q0-29 21-47 17-17 43-17h5q160 13 306 80.5t259 181.5q114 113 181.5 259t80.5 306zm512 2q2 27-18 47-18 20-46 20h-143q-26 0-44.5-17.5t-19.5-42.5q-12-215-101-408.5t-231.5-336q-142.5-142.5-336-231.5t-408.5-102q-25-1-42.5-19.5t-17.5-43.5v-143q0-28 20-46 18-18 44-18h3q262 13 501.5 120t425.5 294q187 186 294 425.5t120 501.5z" fill="currentColor"/></svg>Site RSS feed</a>
            </li>
            <li class="social__item social__item--twitter">
              <a href="https://www.twitter.com/pixelthing" target="_blank" rel="noopener" class="social__link">
                <svg class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 171.505 139.378"><path d="M171.505 16.499a70.337 70.337 0 01-20.208 5.54c7.264-4.354 12.844-11.25 15.47-19.466a70.437 70.437 0 01-22.344 8.538A35.136 35.136 0 00118.74 0C99.308 0 83.553 15.754 83.553 35.185c0 2.758.311 5.444.912 8.019C55.22 41.737 29.295 27.728 11.94 6.44a35.019 35.019 0 00-4.764 17.69c0 12.207 6.211 22.977 15.653 29.286a35.047 35.047 0 01-15.937-4.4c-.004.146-.004.294-.004.442 0 17.048 12.129 31.268 28.225 34.503a35.224 35.224 0 01-15.89.602c4.478 13.979 17.472 24.152 32.87 24.435-12.042 9.438-27.214 15.063-43.7 15.063-2.84 0-5.64-.167-8.393-.492 15.572 9.984 34.067 15.81 53.938 15.81 64.72 0 100.113-53.616 100.113-100.114 0-1.526-.035-3.043-.102-4.553a71.483 71.483 0 0017.556-18.213z" fill="currentColor"/></svg>@pixelthing</a>
              <a href="https://www.twitter.com/itsadatathing" target="_blank" rel="noopener" class="social__link">@itsadatathing</a>
            </li>
            <li class="social__item social__item--instagram">
              <a href="https://www.instagram.com/pixelthing" target="_blank" rel="noopener" class="social__link">
                <svg class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="18 18 96 96"><path fill="currentColor" d="M66 18c-13 0-14.7 0-19.8.3a35 35 0 00-11.6 2.2 23.5 23.5 0 00-8.5 5.6 23.6 23.6 0 00-5.6 8.5c-1.2 3-2 6.5-2.2 11.6C18 51.3 18 53 18 66s0 14.7.3 19.8a35 35 0 002.2 11.6 23.5 23.5 0 005.6 8.5 23.5 23.5 0 008.5 5.6c3 1.2 6.5 2 11.6 2.2 5.1.2 6.8.3 19.8.3s14.7 0 19.8-.3a35 35 0 0011.6-2.2 23.5 23.5 0 008.5-5.6 23.6 23.6 0 005.6-8.5c1.2-3 2-6.5 2.2-11.6.2-5.1.3-6.8.3-19.8s0-14.7-.3-19.8c-.2-5.1-1-8.6-2.2-11.6a23.6 23.6 0 00-5.6-8.5 23.5 23.5 0 00-8.5-5.6c-3-1.2-6.5-2-11.6-2.2C80.7 18 79 18 66 18zm-4.3 8.7H66c12.8 0 14.3 0 19.4.2 4.7.2 7.2 1 9 1.7 2.1.8 3.7 1.9 5.4 3.6a14.9 14.9 0 013.6 5.5c.7 1.7 1.5 4.2 1.7 8.9.2 5 .3 6.6.3 19.4s-.1 14.3-.3 19.4c-.2 4.7-1 7.2-1.7 8.9a14.8 14.8 0 01-3.6 5.5 14.8 14.8 0 01-5.5 3.6 27 27 0 01-8.9 1.6c-5 .3-6.6.3-19.4.3-12.8 0-14.3 0-19.4-.2-4.7-.3-7.2-1-8.9-1.7a14.9 14.9 0 01-5.5-3.6 14.9 14.9 0 01-3.6-5.5c-.7-1.7-1.5-4.2-1.7-9-.2-5-.2-6.5-.2-19.3s0-14.4.2-19.4c.2-4.7 1-7.2 1.7-9a14.9 14.9 0 013.6-5.5 14.9 14.9 0 015.5-3.5c1.7-.7 4.2-1.5 8.9-1.7 4.4-.2 6.2-.3 15.1-.3zm30 8a5.8 5.8 0 105.7 5.7 5.8 5.8 0 00-5.8-5.8zM66 41.2a24.6 24.6 0 100 49.4 24.6 24.6 0 000-49.3zm0 8.7a16 16 0 110 32 16 16 0 010-32z"/></svg>@pixelthing</a>
              <a href="https://www.instagram.com/itsadatathing" target="_blank" rel="noopener" class="social__link">@itsadatathing</a>
            </li>
            <li class="social__item social__item--linkedin">
              <a href="https://www.linkedin.com/in/craigmorey/" target="_blank" rel="noopener" class="social__link">
                <svg  class="social__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 455 455"><g fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"><path d="M246.4 204.35v-.665c-.136.223-.324.446-.442.665h.442z"/><path d="M0 0v455h455V0H0zm141.522 378.002H74.016V174.906h67.506v203.096zm-33.753-230.816h-.446C84.678 147.186 70 131.585 70 112.085c0-19.928 15.107-35.087 38.211-35.087 23.109 0 37.31 15.159 37.752 35.087 0 19.5-14.643 35.101-38.194 35.101zM385 378.002h-67.524V269.345c0-27.291-9.756-45.92-34.195-45.92-18.664 0-29.755 12.543-34.641 24.693-1.776 4.34-2.24 10.373-2.24 16.459v113.426h-67.537s.905-184.043 0-203.096H246.4v28.779c8.973-13.807 24.986-33.547 60.856-33.547 44.437 0 77.744 29.02 77.744 91.398v116.465z"/></g></svg>Linked In</a>
            </li>
          </ul>
        </address>
        <div class="footer__cookies">
          <div id="cookie-dialog-1">
            <h3>Cookies & Tracking</h3>
            <p>This site uses a few cookies & yes, Google Analytics.<p>
            <p>Because it's nice to know if anyone is reading this stuff.</p>
            <p>If you accept cookies, your data is never sold & you are never targeted or tracked cross-site.</p>
            <p>No data is collected unless you accept, promise!</p>
          </div>
          
          <div id="cookie-dialog-2" class="cookies__buttons">
            <button type="submit" id="dialog-cookie-accept" class="cookies__button cookies__button--accept"> Accept </button>
            <button type="submit" id="dialog-cookie-reject" class="cookies__button cookies__button--reject">No to cookies</button>
          </div>
        </div>
        <div class="footer__settings">
          <h3>Settings</h3>
          
          <fieldset class="cookies__settings">
            <legend class="cookies__settings__legend">Your cookie settings</legend>
            <div class="cookies__item">
              <p class="cookies__item__text">Accept functional cookies needed to run the site (required)</p>
              <div class="toggle">
                <input type="radio" class="toggle__input toggle__input--no" disabled />
                <input type="radio" class="toggle__input toggle__input--yes" checked disabled />
                <span class="toggle__slug"></span>
              </div>
            </div>
            <div class="cookies__item">
              <p class="cookies__item__text">Accept Google Analytics cookies </p>
              <div class="toggle">
                <input id="settings-cookie-reject" type="radio" class="toggle__input toggle__input--no" name="cookies-analytics" />
                <label for="settings-cookie-reject" class="toggle__text">Opt-out</label>
                <input id="settings-cookie-accept" type="radio" class="toggle__input toggle__input--yes" name="cookies-analytics" />
                <label for="settings-cookie-accept" class="toggle__text">Accept</label>
                <input type="radio" class="toggle__input toggle__input--maybe" name="cookies-analytics" disabled checked />
                <label class="toggle__text">Undecided</label>
                <span class="toggle__slug"></span>
              </div>
            </div>
          </fieldset>
        </div>
      </div>
    </footer>
    
    
    <script src="/js/image-enlarge.js" async></script>
    <script src="/js/post-title-scroll.js" async></script>
    
    
  </body>
</html>
